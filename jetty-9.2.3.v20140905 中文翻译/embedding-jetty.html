
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>嵌入 Jetty</title>
<link rel="stylesheet" type="text/css" href="css/docbook.css">
<meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1">
<meta name="keywords"
	content="jetty, servlet, servlet-api, cometd, http, spdy, websocket, eclipse, maven, java, server, software">
<link rel="home" href="index.html" title="Jetty : The Definitive Reference">
<link rel="up" href="advanced-embedding.html" title="Chapter&nbsp;25.&nbsp;Embedding">
<link rel="prev" href="advanced-embedding.html" title="Chapter&nbsp;25.&nbsp;Embedding">
<link rel="next" href="embedded-examples.html" title="Embedded Examples">
<link xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension"
	xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook"
	xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net"
	xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times" rel="shortcut icon"
	href="images/favicon.ico">
<script type="text/javascript" src="js/shCore.js"></script>
<script type="text/javascript" src="js/shBrushJava.js"></script>
<script type="text/javascript" src="js/shBrushXml.js"></script>
<script type="text/javascript" src="js/shBrushBash.js"></script>
<script type="text/javascript" src="js/shBrushJScript.js"></script>
<script type="text/javascript" src="js/shBrushSql.js"></script>
<script type="text/javascript" src="js/shBrushProperties.js"></script>
<script type="text/javascript" src="js/shBrushPlain.js"></script>
<link type="text/css" rel="stylesheet" href="css/shCore.css">
<link type="text/css" rel="stylesheet" href="css/shThemeEclipse.css">
<link type="text/css" rel="stylesheet" href="css/font-awesome.min.css">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
	<table xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension"
		xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook"
		xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net"
		xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times">
		<tr>
			<td style="width: 25%"><a href="http://www.eclipse.org/jetty"><img src="images/jetty-header-logo.png"
					alt="Jetty Logo"></a><br>
			<span style="font-size: small"> Version: 9.2.3.v20140905</span></td>
			<td style="width: 50%"><script type="text/javascript">
				(function() {
					var cx = '016459005284625897022:obd4lsai2ds';
					var gcse = document.createElement('script');
					gcse.type = 'text/javascript';
					gcse.async = true;
					gcse.src = (document.location.protocol == 'https:' ? 'https:'
							: 'http:')
							+ '//www.google.com/cse/cse.js?cx=' + cx;
					var s = document.getElementsByTagName('script')[0];
					s.parentNode.insertBefore(gcse, s);
				})();
			</script>
				<gcse:search></gcse:search></td>
		</tr>
	</table>
	<div xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension"
		xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook"
		xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net"
		xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times" class="navheader">
		<table width="100%" summary="Navigation header">
			<tr>
				<th colspan="3" align="center">嵌入 Jetty</th>
			</tr>
			<tr>
				<td width="20%" align="left"><a accesskey="p" href="advanced-embedding.html"><i class="icon-chevron-left"></i>
						Previous</a>&nbsp;</td>
				<th width="60%" align="center">第25章 嵌入<br>
				<a accesskey="p" href="index.html"><i class="icon-home"></i> Home</a></th>
				<td width="20%" align="right">&nbsp;<a accesskey="n" href="embedded-examples.html">Next <i
						class="icon-chevron-right"></i></a></td>
			</tr>
		</table>
		<hr>
	</div>
	<div xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension"
		xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook"
		xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net"
		xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times" class="jetty-callout">
		<h5 class="callout">
			<a href="http://www.webtide.com/">Contact the core Jetty developers at <span class="website">www.webtide.com</span></a>
		</h5>
		<p>private support for your internal/customer projects ... custom extensions and distributions ... versioned
			snapshots for indefinite support ... scalability guidance for your apps and Ajax/Comet projects ... development
			services from 1 day to full product delivery</p>
	</div>
	<div class="section">
		<div class="titlepage">
			<div>
				<div>
					<h2 class="title" style="clear: both">
						<a name="embedding-jetty"></a>嵌入 Jetty
					</h2>
				</div>
			</div>
		</div>
		<div class="toc">
			<dl>
				<dt>
					<span class="section"><a href="embedding-jetty.html#d0e18670">概览</a></span>
				</dt>
				<dt>
					<span class="section"><a href="embedding-jetty.html#d0e18707">创建 Server</a></span>
				</dt>
				<dt>
					<span class="section"><a href="embedding-jetty.html#d0e18718">使用 Handlers</a></span>
				</dt>
				<dt>
					<span class="section"><a href="embedding-jetty.html#d0e18847">嵌入 Connectors</a></span>
				</dt>
				<dt>
					<span class="section"><a href="embedding-jetty.html#d0e18895">嵌入 Servlets</a></span>
				</dt>
				<dt>
					<span class="section"><a href="embedding-jetty.html#d0e18913">嵌入 Contexts</a></span>
				</dt>
				<dt>
					<span class="section"><a href="embedding-jetty.html#d0e18965">嵌入 ServletContexts</a></span>
				</dt>
				<dt>
					<span class="section"><a href="embedding-jetty.html#d0e18985">嵌入 Web Applications</a></span>
				</dt>
				<dt>
					<span class="section"><a href="embedding-jetty.html#d0e19002">Jetty XML</a></span>
				</dt>
			</dl>
		</div>
		<p>
			Jetty 有一个标语, "<span class="emphasis"><em>不要部署你的应用程序到 Jetty, 将 Jetty 部署到你的应用程序中!</em></span>" 
			这意味着作为一种替代方法构建你的应用程序作为一个标准的 WAR,部署到 Jetty 中.Jetty 被设计成一种可以被实例化并在一个 Java 程序比如任意的 POJO 中使用的软件组件.
			换句话说,以嵌入式模式运行 Jetty 意味着将一个 HTTP 模块放入到你的应用程序中,而不是把你的应用程序放到一个 HTTP 服务器中.
		</p>
		<p>这个教程带领你从最简单的 Jetty 服务器实例化运行多个 web 应程序开始,使用基于标准的部署描述符.这些示例的源代码是 Jetty 项目的一部分.</p>
		<div class="section">
			<div class="titlepage">
				<div>
					<div>
						<h3 class="title">
							<a name="d0e18670"></a>概览
						</h3>
					</div>
				</div>
			</div>
			<p>为了嵌入一个 Jetty 服务器,下面的步骤是比较典型的,通过本教程中的示例说明:</p>
			<div class="orderedlist">
				<ol class="orderedlist" type="1">
					<li class="listitem"><p>
							创建一个 <a class="link"
								href="http://download.eclipse.org/jetty/stable-9/apidocs/org/eclipse/jetty/server/Server.html" target="_top">Server</a>
							实例.
						</p></li>
					<li class="listitem"><p>
							添加/配置 <a class="link"
								href="http://download.eclipse.org/jetty/stable-9/apidocs/org/eclipse/jetty/server/Connector.html" target="_top">Connectors</a>.
						</p></li>
					<li class="listitem"><p>
							添加/配置 <a class="link"
								href="http://download.eclipse.org/jetty/stable-9/apidocs/org/eclipse/jetty/server/Handler.html" target="_top">Handlers</a>
							和/或 <a class="link"
								href="http://download.eclipse.org/jetty/stable-9/apidocs/org/eclipse/jetty/server/handler/ContextHandler.html"
								target="_top">Contexts</a> 和/或  <a class="link"
								href="http://docs.oracle.com/javaee/6/api/javax/servlet/Servlet.html" target="_top">Servlets</a>.
						</p></li>
					<li class="listitem"><p>启动 Server.</p></li>
					<li class="listitem"><p>在服务器上等待或者使用你的线程做一些其它的事情.</p></li>
				</ol>
			</div>
			<p></p>
		</div>
		<div class="section">
			<div class="titlepage">
				<div>
					<div>
						<h3 class="title">
							<a name="d0e18707"></a>创建 Server
						</h3>
					</div>
				</div>
			</div>
			<p>下面的代码从 SimplestServer.java 实例化和运行最简单可用的 Jetty 服务器:</p>
			<div class="informalexample">
				<script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[//
//  ========================================================================
//  Copyright (c) 1995-2014 Mort Bay Consulting Pty. Ltd.
//  ------------------------------------------------------------------------
//  All rights reserved. This program and the accompanying materials
//  are made available under the terms of the Eclipse Public License v1.0
//  and Apache License v2.0 which accompanies this distribution.
//
//      The Eclipse Public License is available at
//      http://www.eclipse.org/legal/epl-v10.html
//
//      The Apache License v2.0 is available at
//      http://www.opensource.org/licenses/apache2.0.php
//
//  You may elect to redistribute this code under either of these licenses.
//  ========================================================================
//

package org.eclipse.jetty.embedded;

import org.eclipse.jetty.server.Server;

/**
 * The simplest possible Jetty server.
 */
public class SimplestServer
{
    public static void main( String[] args ) throws Exception
    {
        Server server = new Server(8080);
        server.start();
        server.dumpStdErr();
        server.join();
    }
}
]]>
        </script>
			</div>
			<p>这个运行一个 HTTP 服务器在 8080 端口上.它不是一个有用的服务器,因为它没有 handlers,因此为每个请求返回一个 404 错误.</p>
		</div>
		<div class="section">
			<div class="titlepage">
				<div>
					<div>
						<h3 class="title">
							<a name="d0e18718"></a>使用 Handlers
						</h3>
					</div>
				</div>
			</div>
			<p>
				为了为一个请求产生响应,Jetty 需要你在 server 上设置一个 <a class="link" href="http://download.eclipse.org/jetty/stable-9/apidocs/org/eclipse/jetty/server/Handler.html" target="_top">Handler</a>.一个 handler 可以是:
			</p>
			<div class="itemizedlist">
				<ul class="itemizedlist" type="disc">
					<li class="listitem"><p>检查/修改 HTTP 请求.</p></li>
					<li class="listitem"><p>生成和完成 HTTP 响应.</p></li>
					<li class="listitem"><p>调用另一个 Handler (见 HandlerWrapper).</p></li>
					<li class="listitem"><p>选择一个或许多 Handlers 去调用(见 HandlerCollection).</p></li>
				</ul>
			</div>
			<div class="section">
				<div class="titlepage">
					<div>
						<div>
							<h4 class="title">
								<a name="d0e18739"></a>HelloWorld Handler
							</h4>
						</div>
					</div>
				</div>
				<p>下面的代码基于 HelloHandler.java 展示了一个简单的 hello world handler:</p>
				<div class="informalexample">
					<script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[//
//  ========================================================================
//  Copyright (c) 1995-2014 Mort Bay Consulting Pty. Ltd.
//  ------------------------------------------------------------------------
//  All rights reserved. This program and the accompanying materials
//  are made available under the terms of the Eclipse Public License v1.0
//  and Apache License v2.0 which accompanies this distribution.
//
//      The Eclipse Public License is available at
//      http://www.eclipse.org/legal/epl-v10.html
//
//      The Apache License v2.0 is available at
//      http://www.opensource.org/licenses/apache2.0.php
//
//  You may elect to redistribute this code under either of these licenses.
//  ========================================================================
//

package org.eclipse.jetty.embedded;

import java.io.IOException;
import java.io.PrintWriter;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.eclipse.jetty.server.Request;
import org.eclipse.jetty.server.handler.AbstractHandler;

public class HelloHandler extends AbstractHandler
{
    final String greeting;
    final String body;

    public HelloHandler()
    {
        this("Hello World");
    }

    public HelloHandler( String greeting )
    {
        this(greeting, null);
    }

    public HelloHandler( String greeting, String body )
    {
        this.greeting = greeting;
        this.body = body;
    }

    public void handle( String target,
                        Request baseRequest,
                        HttpServletRequest request,
                        HttpServletResponse response ) throws IOException,
                                                      ServletException
    {
        response.setContentType("text/html; charset=utf-8");
        response.setStatus(HttpServletResponse.SC_OK);

        PrintWriter out = response.getWriter();

        out.println("<h1>" + greeting + "</h1>");
        if (body != null)
        {
            out.println(body);
        }

        baseRequest.setHandled(true);
    }
}
]]>
        </script>
				</div>
				<p>传递到 handle 方法中的参数是:</p>
				<div class="itemizedlist">
					<ul class="itemizedlist" type="disc">
						<li class="listitem"><p>target&#8211;请求的目标,是一个 URI 或一个来自命名的 dispatcher 的名称.</p></li>
						<li class="listitem"><p>baseRequest&#8211;Jetty 可变的请求对象,总是未包装.</p></li>
						<li class="listitem"><p>request&#8211;不可变的请求对象,可以已经被一个 filter 或 servlet 包装过.</p></li>
						<li class="listitem"><p>response&#8211;响应,可以已经被一个 filter 或 servlet 包装过.</p></li>
					</ul>
				</div>
				<p>handler 设置相应状态,content-type,和标记请求已经被处理过了,在它使用 writer 生成响应的 body 之前.</p>
			</div>
			<div class="section">
				<div class="titlepage">
					<div>
						<div>
							<h4 class="title">
								<a name="d0e18765"></a>运行 HelloWorldHandler
							</h4>
						</div>
					</div>
				</div>
				<p>为了允许一个 Handler 处理 HTTP 请求,你必须将它添加到 Server 实例中.下面的代码来自 OneHandler.java 展示了一个 Jetty 服务器如何可以使用 HelloWorld handler:</p>
				<div class="informalexample">
					<script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[//
//  ========================================================================
//  Copyright (c) 1995-2014 Mort Bay Consulting Pty. Ltd.
//  ------------------------------------------------------------------------
//  All rights reserved. This program and the accompanying materials
//  are made available under the terms of the Eclipse Public License v1.0
//  and Apache License v2.0 which accompanies this distribution.
//
//      The Eclipse Public License is available at
//      http://www.eclipse.org/legal/epl-v10.html
//
//      The Apache License v2.0 is available at
//      http://www.opensource.org/licenses/apache2.0.php
//
//  You may elect to redistribute this code under either of these licenses.
//  ========================================================================
//

package org.eclipse.jetty.embedded;

import org.eclipse.jetty.server.Server;

public class OneHandler
{
    public static void main( String[] args ) throws Exception
    {
        Server server = new Server(8080);
        server.setHandler(new HelloHandler());

        server.start();
        server.join();
    }
}
]]>
        </script>
				</div>
				<p>一个或多个 handlers 在 Jetty 中做所有的请求处理.一些 handlers 选择其它特殊的 handlers(比如,一个 ContextHandlerCollection 使用 context path 去选择一个 ContextHandler);
				其它的使用应用程序逻辑去生成响应(比如, ServletHandler 传递请求给一个应用程序 Servlet),同时其它的做一些和生成响应无关的任务(比如, RequestLogHandler 或 StatisticsHandler).</p>
				<p>
					后面的章节向你描述如何组合 handlers 之类的问题.你可以在 <a class="link"
						href="http://download.eclipse.org/jetty/stable-9/xref/org/eclipse/jetty/server/handler/package-summary.html"
						target="_top"> org.eclipse.jetty.server.handler</a> 包中看到一些在 Jetty 中可用的 handlers.
				</p>
			</div>
			<div class="section">
				<div class="titlepage">
					<div>
						<div>
							<h4 class="title">
								<a name="d0e18783"></a>Handler Collections 和 Wrappers
							</h4>
						</div>
					</div>
				</div>
				<p>
					复杂的请求处理通常从你可以以各种方式组合的多个 Handlers 中构建.Jetty 有几个 <a class="link"
					href="http://download.eclipse.org/jetty/stable-9/apidocs/org/eclipse/jetty/server/HandlerContainer.html"
					target="_top">HandlerContainer</a> 接口的实现:
				</p>
				<div class="variablelist">
					<dl>
						<dt>
							<span class="term"><a class="link"
								href="http://download.eclipse.org/jetty/stable-9/apidocs/org/eclipse/jetty/server/handler/HandlerCollection.html"
								target="_top">HandlerCollection</a></span>
						</dt>
						<dd>
							<p>保存了其它 handlers 的集合,顺序调用每一个 handler.这个非常有用对于组合静态和日志 handlers及生成响应的 handler.</p>
						</dd>
						<dt>
							<span class="term"><a class="link"
								href="http://download.eclipse.org/jetty/stable-9/apidocs/org/eclipse/jetty/server/handler/HandlerList.html"
								target="_top">HandlerList</a></span>
						</dt>
						<dd>
							<p>一个 Handler Collection 顺序调用每个 handler,直到有一个异常抛出,响应被提交或 request.isHandled() 返回 true.你可以使用它组合有条件处理一个请求的 handlers,比如调用多个 contexts 直到一个匹配虚拟主机.</p>
						</dd>
						<dt>
							<span class="term"><a class="link"
								href="http://download.eclipse.org/jetty/stable-9/apidocs/org/eclipse/jetty/server/handler/HandlerWrapper.html"
								target="_top">HandlerWrapper</a></span>
						</dt>
						<dd>
							<p>一个 Handler 基类你可以用来以面向方面编程的方式将 handlers 链接在一起.比如,一个标准的 web 应用程序通过一个 context,session,security 和 servlet handlers 链接在一起实现.</p>
						</dd>
						<dt>
							<span class="term"><a class="link"
								href="http://download.eclipse.org/jetty/stable-9/apidocs/org/eclipse/jetty/server/handler/ContextHandlerCollection.html"
								target="_top">ContextHandlerCollection</a></span>
						</dt>
						<dd>
							<p>一个特定的 HandlerCollection 使用请求的 URI 的最长前缀去选择一个包含的 ContextHandler 去处理请求.</p>
						</dd>
					</dl>
				</div>
			</div>
			<div class="section">
				<div class="titlepage">
					<div>
						<div>
							<h4 class="title">
								<a name="d0e18820"></a>Scoped Handlers
							</h4>
						</div>
					</div>
				</div>
				<p>在 Jetty 中许多的标准 Servlet 容器使用 HandlerWrappers 将 handlers 链接在一起实现: ContextHandler 到 SessionHandler 到 SecurityHandler 到 ServletHandler.然而,因为 servlet 规范的性质,
				这个链接不能是存储的 handlers,因为 outer handlers 有时候需要 inner handlers 处理的信息.比如,当一个 ContextHandler 调用某些应用程序监听去去通知它们一个请求进入了 context,
				它必须已经知道 ServletHandler 将派发请求到哪个 servlet,这样 servletPath 方法返回正确的值.</p>
				<p>
					HandlerWrapper 是专用于<a class="link"
href="http://download.eclipse.org/jetty/stable-9/xref/org/eclipse/jetty/server/handler/ScopedHandler.html"
target="_top">ScopedHandler</a> 抽象类的.支持 scopes 的 daisy 链.比如,如果一个 ServletHandler 内嵌在一个 ContextHandler 中,顺序和方法的内部执行是:
				</p>
				<div class="literallayout">
					<p>
						Server.handle(...)<br> &nbsp;&nbsp;ContextHandler.doScope(...)<br>
						&nbsp;&nbsp;&nbsp;&nbsp;ServletHandler.doScope(...)<br>
						&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContextHandler.doHandle(...)<br>
						&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServletHandler.doHandle(...)<br>
						&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SomeServlet.service(...)
					</p>
				</div>
				<p>因此当 ContextHandler 处理请求,它在 ServletHandler 建立的 scope 中是这样做的.</p>
			</div>
			<div class="section">
				<div class="titlepage">
					<div>
						<div>
							<h4 class="title">
								<a name="d0e18834"></a>Resource Handler
							</h4>
						</div>
					</div>
				</div>
				<p>
					<a class="link" href="http://download.eclipse.org/jetty/stable-9/xref/org/eclipse/jetty/embedded/FileServer.html" target="_top">FileServer
example</a> 向你展示了你如何使用一个 ResourceHandler 从当前的工作目录服务一个静态内容:
				</p>
				<script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[//
//  ========================================================================
//  Copyright (c) 1995-2014 Mort Bay Consulting Pty. Ltd.
//  ------------------------------------------------------------------------
//  All rights reserved. This program and the accompanying materials
//  are made available under the terms of the Eclipse Public License v1.0
//  and Apache License v2.0 which accompanies this distribution.
//
//      The Eclipse Public License is available at
//      http://www.eclipse.org/legal/epl-v10.html
//
//      The Apache License v2.0 is available at
//      http://www.opensource.org/licenses/apache2.0.php
//
//  You may elect to redistribute this code under either of these licenses.
//  ========================================================================
//

package org.eclipse.jetty.embedded;

import org.eclipse.jetty.server.Handler;
import org.eclipse.jetty.server.Server;
import org.eclipse.jetty.server.handler.DefaultHandler;
import org.eclipse.jetty.server.handler.HandlerList;
import org.eclipse.jetty.server.handler.ResourceHandler;

/** 
 * Simple Jetty FileServer.
 * This is a simple example of Jetty configured as a FileServer.
 */
public class FileServer
{
    public static void main(String[] args) throws Exception
    {
        // Create a basic Jetty server object that will listen on port 8080.  Note that if you set this to port 0
        // then a randomly available port will be assigned that you can either look in the logs for the port,
        // or programmatically obtain it for use in test cases.
        Server server = new Server(8080);

        // Create the ResourceHandler. It is the object that will actually handle the request for a given file. It is
        // a Jetty Handler object so it is suitable for chaining with other handlers as you will see in other examples.
        ResourceHandler resource_handler = new ResourceHandler();
        // Configure the ResourceHandler. Setting the resource base indicates where the files should be served out of.
        // In this example it is the current directory but it can be configured to anything that the jvm has access to.
        resource_handler.setDirectoriesListed(true);
        resource_handler.setWelcomeFiles(new String[]{ "index.html" });
        resource_handler.setResourceBase(".");

        // Add the ResourceHandler to the server.
        HandlerList handlers = new HandlerList();
        handlers.setHandlers(new Handler[] { resource_handler, new DefaultHandler() });
        server.setHandler(handlers);

        // Start things up! By using the server.join() the server thread will join with the current thread.
        // See "http://docs.oracle.com/javase/1.5.0/docs/api/java/lang/Thread.html#join()" for more details.
        server.start();
        server.join();
    }
}
]]>
        </script>
				<p>注意 HandlerList 使用了 ResourceHandler 和 DefaultHandler,这样 DefaultHandler 为任意的没有匹配一个静态资源的请求生成一个良好的 404 响应.</p>
			</div>
		</div>
		<div class="section">
			<div class="titlepage">
				<div>
					<div>
						<h3 class="title">
							<a name="d0e18847"></a>嵌入 Connectors
						</h3>
					</div>
				</div>
			</div>
			<p>在之前的示例中,Server 实例被传递了一个端口,它内部创建一个默认的 Connector 实例,在端口上监听请求.然而,通常当嵌入 Jetty 的时候,值得为一个 Server 实例明确实例化和配置一个或多个 Connectors.</p>
			<div class="section">
				<div class="titlepage">
					<div>
						<div>
							<h4 class="title">
								<a name="d0e18852"></a>一个 Connector
							</h4>
						</div>
					</div>
				</div>
				<p>
					下面的示例, <a class="link" href="http://download.eclipse.org/jetty/stable-9/xref/org/eclipse/jetty/embedded/OneConnector.html" target="_top">OneConnector.java</a>,实例化,配置和添加单个的 HTTP connector 实例到 server:
				</p>
				<script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[//
//  ========================================================================
//  Copyright (c) 1995-2014 Mort Bay Consulting Pty. Ltd.
//  ------------------------------------------------------------------------
//  All rights reserved. This program and the accompanying materials
//  are made available under the terms of the Eclipse Public License v1.0
//  and Apache License v2.0 which accompanies this distribution.
//
//      The Eclipse Public License is available at
//      http://www.eclipse.org/legal/epl-v10.html
//
//      The Apache License v2.0 is available at
//      http://www.opensource.org/licenses/apache2.0.php
//
//  You may elect to redistribute this code under either of these licenses.
//  ========================================================================
//

package org.eclipse.jetty.embedded;

import org.eclipse.jetty.server.Server;
import org.eclipse.jetty.server.ServerConnector;

/**
 * A Jetty server with one connectors.
 */
public class OneConnector
{
    public static void main( String[] args ) throws Exception
    {
        // The Server
        Server server = new Server();

        // HTTP connector
        ServerConnector http = new ServerConnector(server);
        http.setHost("localhost");
        http.setPort(8080);
        http.setIdleTimeout(30000);

        // Set the connector
        server.addConnector(http);

        // Set a handler
        server.setHandler(new HelloHandler());

        // Start the server
        server.start();
        server.join();
    }
}
]]>
        </script>
				<p>
					在这个例子中 connector 处理 HTTP 协议,因为它默认用于 <a class="link"
href="http://download.eclipse.org/jetty/stable-9/xref/org/eclipse/jetty/server/ServerConnector.html" target="_top">ServerConnector</a> 类.
				</p>
			</div>
			<div class="section">
				<div class="titlepage">
					<div>
						<div>
							<h4 class="title">
								<a name="d0e18868"></a>多个 Connectors
							</h4>
						</div>
					</div>
				</div>
				<p>当配置多个 connectors(比如,HTTP 和 HTTPS),共享用于 HTTP 的常用的参数是可取的.为了完成这个,你需要明确使用 ConnectionFactory 实例配置  ServerConnector 类,并向它们提供常用的 HTTP 配置.</p>
				<p>
					<a class="link" href="http://download.eclipse.org/jetty/stable-9/xref/org/eclipse/jetty/embedded/ManyConnectors.html"
target="_top">ManyConnectors 示例</a>,使用两个 ServerConnector 实例配置一个 serve: http connector 有一个 <a class="link"
href="http://download.eclipse.org/jetty/stable-9/xref/org/eclipse/jetty/server/HttpConnectionFactory.html"
target="_top">HTTPConnectionFactory</a> 实例;https connector 有一个 SslConnectionFactory 链到一个 HttpConnectionFactory 上.这两个 HttpConnectionFactories 基于相同的 <a class="link"
href="http://download.eclipse.org/jetty/stable-9/xref/org/eclipse/jetty/server/HttpConfiguration.html"
target="_top">HttpConfiguration</a> 实例配置,然而,HTTPS 工厂使用一个包装的配置,这样一个 <a
class="link"
href="http://download.eclipse.org/jetty/stable-9/xref/org/eclipse/jetty/server/SecureRequestCustomizer.html"
target="_top">SecureRequestCustomizer</a> 可以被添加.
				</p>
			</div>
			<div class="section">
				<div class="titlepage">
					<div>
						<div>
							<h4 class="title">
								<a name="d0e18887"></a>SPDY Connectors
							</h4>
						</div>
					</div>
				</div>
				<p>
					<a class="link" href="http://download.eclipse.org/jetty/stable-9/xref/org/eclipse/jetty/embedded/SpdyConnector.html" target="_top">SPDYConnector 示例</a> 类似于 HTTPS connector,
					除了 SslConnectionFactory 被链到 NPNConnectionFactory,协商下一代协议是 SPDY/2, SPDY/3 还是 HTTPS.
				</p>
			</div>
		</div>
		<div class="section">
			<div class="titlepage">
				<div>
					<div>
						<h3 class="title">
							<a name="d0e18895"></a>嵌入 Servlets
						</h3>
					</div>
				</div>
			</div>
			<p>
				<a class="link" href="http://en.wikipedia.org/wiki/Java_Servlet" target="_top">Servlets</a> 是提供应用程序逻辑处理 HTTP 请求的标准方式.Servlets 类似于 Jetty Handler,除了请求对象是不可变的,因此不能被修改.Servlets 在 Jetty 中通过 <a class="link"
href="http://download.eclipse.org/jetty/stable-9/xref/org/eclipse/jetty/embedded/MinimalServlets.html"
target="_top">ServletHandler</a> 处理.它使用标准的路径映射去配置一个 Servlet 到一个请求;设定请求 servletPath 和 pathInfo;传递请求到 servlet,可以通过 Filters 产生响应.
			</p>
			<p>
				<a class="link" href="http://download.eclipse.org/jetty/stable-9/xref/org/eclipse/jetty/embedded/MinimalServlets.html"
target="_top">MinimalServlets 示例</a> 创建一个 ServletHandler 实例并配置单个的 HelloServlet:
			</p>
			<script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[//
//  ========================================================================
//  Copyright (c) 1995-2014 Mort Bay Consulting Pty. Ltd.
//  ------------------------------------------------------------------------
//  All rights reserved. This program and the accompanying materials
//  are made available under the terms of the Eclipse Public License v1.0
//  and Apache License v2.0 which accompanies this distribution.
//
//      The Eclipse Public License is available at
//      http://www.eclipse.org/legal/epl-v10.html
//
//      The Apache License v2.0 is available at
//      http://www.opensource.org/licenses/apache2.0.php
//
//  You may elect to redistribute this code under either of these licenses.
//  ========================================================================
//

package org.eclipse.jetty.embedded;

import java.io.IOException;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.eclipse.jetty.server.Server;
import org.eclipse.jetty.servlet.ServletHandler;

public class MinimalServlets
{
    public static void main( String[] args ) throws Exception
    {
        // Create a basic jetty server object that will listen on port 8080.
        // Note that if you set this to port 0 then a randomly available port
        // will be assigned that you can either look in the logs for the port,
        // or programmatically obtain it for use in test cases.
        Server server = new Server(8080);

        // The ServletHandler is a dead simple way to create a context handler
        // that is backed by an instance of a Servlet.
        // This handler then needs to be registered with the Server object.
        ServletHandler handler = new ServletHandler();
        server.setHandler(handler);

        // Passing in the class for the Servlet allows jetty to instantiate an
        // instance of that Servlet and mount it on a given context path.

        // IMPORTANT:
        // This is a raw Servlet, not a Servlet that has been configured
        // through a web.xml @WebServlet annotation, or anything similar.
        handler.addServletWithMapping(HelloServlet.class, "/*");

        // Start things up!
        server.start();

        // The use of server.join() the will make the current thread join and
        // wait until the server is done executing.
        // See
        // http://docs.oracle.com/javase/7/docs/api/java/lang/Thread.html#join()
        server.join();
    }

    @SuppressWarnings("serial")
    public static class HelloServlet extends HttpServlet
    {
        @Override
        protected void doGet( HttpServletRequest request,
                              HttpServletResponse response ) throws ServletException,
                                                            IOException
        {
            response.setContentType("text/html");
            response.setStatus(HttpServletResponse.SC_OK);
            response.getWriter().println("<h1>Hello from HelloServlet</h1>");
        }
    }
}
]]>
        </script>
		</div>
		<div class="section">
			<div class="titlepage">
				<div>
					<div>
						<h3 class="title">
							<a name="d0e18913"></a>嵌入 Contexts
						</h3>
					</div>
				</div>
			</div>
			<p>
				A <a class="link" href="http://download.eclipse.org/jetty/stable-9/xref/org/eclipse/jetty/embedded/OneContext.html"
target="_top">ContextHandler</a> 是一个 ScopedHandler,只有当请求有一个 URI 前缀匹配配置的 context path 才产生响应.匹配上下文路径的请求有自己的路径方法相应地更新,并且 contexts scope 是可用的,选项可能包括:
			</p>
			<div class="itemizedlist">
				<ul class="itemizedlist" type="disc">
					<li class="listitem"><p>Classloader 被设置为 Thread context classloader 当请求处理在范围中的时候.</p></li>
					<li class="listitem"><p>
							一组属性通过 <a class="link" href="http://docs.oracle.com/javaee/6/api/javax/servlet/ServletContext.html" target="_top">ServletContext</a> API 可用.
						</p></li>
					<li class="listitem"><p>
							一组初始参数通过 <a class="link" href="http://docs.oracle.com/javaee/6/api/javax/servlet/ServletContext.html" target="_top">ServletContext</a> API 可用.
						</p></li>
					<li class="listitem"><p>
							一个基本的 Resource,作为文档根目录用于静态资源请求,通过 <a class="link" href="http://docs.oracle.com/javaee/6/api/javax/servlet/ServletContext.html" target="_top">ServletContext</a> API.
						</p></li>
					<li class="listitem"><p>一组虚拟主机名称.</p></li>
				</ul>
			</div>
			<p>
				下面的 <a class="link"
href="http://download.eclipse.org/jetty/stable-9/xref/org/eclipse/jetty/embedded/OneContext.html" target="_top">OneContext
示例</a> 展示了一个 context 被建立,包装了 <a class="link"
href="http://download.eclipse.org/jetty/stable-9/xref/org/eclipse/jetty/embedded/HelloHandler.html" target="_top">HelloHandler</a>:
			</p>
			<script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[//
//  ========================================================================
//  Copyright (c) 1995-2014 Mort Bay Consulting Pty. Ltd.
//  ------------------------------------------------------------------------
//  All rights reserved. This program and the accompanying materials
//  are made available under the terms of the Eclipse Public License v1.0
//  and Apache License v2.0 which accompanies this distribution.
//
//      The Eclipse Public License is available at
//      http://www.eclipse.org/legal/epl-v10.html
//
//      The Apache License v2.0 is available at
//      http://www.opensource.org/licenses/apache2.0.php
//
//  You may elect to redistribute this code under either of these licenses.
//  ========================================================================
//

package org.eclipse.jetty.embedded;

import org.eclipse.jetty.server.Server;
import org.eclipse.jetty.server.handler.ContextHandler;

public class OneContext
{
    public static void main( String[] args ) throws Exception
    {
        Server server = new Server( 8080 );

        // Add a single handler on context "/hello"
        ContextHandler context = new ContextHandler();
        context.setContextPath( "/hello" );
        context.setHandler( new HelloHandler() );

        // Can be accessed using http://localhost:8080/hello

        server.setHandler( context );

        // Start the server
        server.start();
        server.join();
    }
}
]]>
        </script>
			<p>
				当有多个 contexts 存在,你可以嵌入一个 ContextHandlerCollection 有效地检查一个请求 URI,然后选择匹配的 ContextHandler(s) 用于请求.The <a class="link" href="http://download.eclipse.org/jetty/stable-9/xref/org/eclipse/jetty/embedded/ManyContexts.html" target="_top">ManyContexts
示例</a> 展示了你可以如何配置多个 contexts:
			</p>
			<script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[//
//  ========================================================================
//  Copyright (c) 1995-2014 Mort Bay Consulting Pty. Ltd.
//  ------------------------------------------------------------------------
//  All rights reserved. This program and the accompanying materials
//  are made available under the terms of the Eclipse Public License v1.0
//  and Apache License v2.0 which accompanies this distribution.
//
//      The Eclipse Public License is available at
//      http://www.eclipse.org/legal/epl-v10.html
//
//      The Apache License v2.0 is available at
//      http://www.opensource.org/licenses/apache2.0.php
//
//  You may elect to redistribute this code under either of these licenses.
//  ========================================================================
//

package org.eclipse.jetty.embedded;

import org.eclipse.jetty.server.Handler;
import org.eclipse.jetty.server.Server;
import org.eclipse.jetty.server.handler.ContextHandler;
import org.eclipse.jetty.server.handler.ContextHandlerCollection;

public class ManyContexts
{
    public static void main( String[] args ) throws Exception
    {
        Server server = new Server(8080);

        ContextHandler context = new ContextHandler("/");
        context.setContextPath("/");
        context.setHandler(new HelloHandler("Root Hello"));

        ContextHandler contextFR = new ContextHandler("/fr");
        contextFR.setHandler(new HelloHandler("Bonjoir"));

        ContextHandler contextIT = new ContextHandler("/it");
        contextIT.setHandler(new HelloHandler("Bongiorno"));

        ContextHandler contextV = new ContextHandler("/");
        contextV.setVirtualHosts(new String[] { "127.0.0.2" });
        contextV.setHandler(new HelloHandler("Virtual Hello"));

        ContextHandlerCollection contexts = new ContextHandlerCollection();
        contexts.setHandlers(new Handler[] { context, contextFR, contextIT,
                contextV });

        server.setHandler(contexts);

        server.start();
        server.join();
    }
}
]]>
        </script>
		</div>
		<div class="section">
			<div class="titlepage">
				<div>
					<div>
						<h3 class="title">
							<a name="d0e18965"></a>嵌入 ServletContexts
						</h3>
					</div>
				</div>
			</div>
			<p>
				<a class="link"
href="http://download.eclipse.org/jetty/stable-9/xref/org/eclipse/jetty/servlet/ServletContextHandler.html"
target="_top">ServletContextHandler</a> 是一种特殊的 ContextHandler,支持标准的 sessions 和 Servlets.下面的 <a class="link"
href="http://download.eclipse.org/jetty/stable-9/xref/org/eclipse/jetty/embedded/OneServletContext.html"
target="_top">OneServletContext 示例</a> 实例化一个 <a class="link"
href="http://download.eclipse.org/jetty/stable-9/xref/org/eclipse/jetty/servlet/DefaultServlet.html" target="_top">DefaultServlet</a> 服务来自 /tmp/ 中的静态内容,
<a class="link" href="???" target="_top">DumpServlet</a> 创建一个 session 并 dump 关于请求的基本细节.
			</p>
			<script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[//
//  ========================================================================
//  Copyright (c) 1995-2014 Mort Bay Consulting Pty. Ltd.
//  ------------------------------------------------------------------------
//  All rights reserved. This program and the accompanying materials
//  are made available under the terms of the Eclipse Public License v1.0
//  and Apache License v2.0 which accompanies this distribution.
//
//      The Eclipse Public License is available at
//      http://www.eclipse.org/legal/epl-v10.html
//
//      The Apache License v2.0 is available at
//      http://www.opensource.org/licenses/apache2.0.php
//
//  You may elect to redistribute this code under either of these licenses.
//  ========================================================================
//

package org.eclipse.jetty.embedded;

import org.eclipse.jetty.server.Server;
import org.eclipse.jetty.servlet.DefaultServlet;
import org.eclipse.jetty.servlet.ServletContextHandler;

public class OneServletContext
{
    public static void main( String[] args ) throws Exception
    {
        Server server = new Server(8080);

        ServletContextHandler context = new ServletContextHandler(
                ServletContextHandler.SESSIONS);
        context.setContextPath("/");
        context.setResourceBase(System.getProperty("java.io.tmpdir"));
        server.setHandler(context);

        // Add dump servlet
        context.addServlet(DumpServlet.class, "/dump/*");
        // Add default servlet
        context.addServlet(DefaultServlet.class, "/");

        server.start();
        server.join();
    }
}
]]>
        </script>
		</div>
		<div class="section">
			<div class="titlepage">
				<div>
					<div>
						<h3 class="title">
							<a name="d0e18985"></a>嵌入 Web 应用程序
						</h3>
					</div>
				</div>
			</div>
			<p>
				<a class="link" href="http://download.eclipse.org/jetty/stable-9/xref/org/eclipse/jetty/webapp/WebAppContext.html"
target="_top">WebAppContext</a> 是 ServletContextHandler 的扩展使用 <a class="link" href="http://en.wikipedia.org/wiki/WAR_%28Sun_file_format%29" target="_top">标准布局</a> 和 web.xml 配置 servlets,filters,和其它的来自web.xml 和/或注解中的特性.下面的 <a class="link"
href="http://download.eclipse.org/jetty/stable-9/xref/org/eclipse/jetty/embedded/OneWebApp.html" target="_top">OneWebApp
example</a> 配置了 Jetty test webapp.Web 应用程序可以使用容器提供的资源,在这个例子中,一个 LoginService 是需要的,同样被配置:
			</p>
			<script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[//
//  ========================================================================
//  Copyright (c) 1995-2014 Mort Bay Consulting Pty. Ltd.
//  ------------------------------------------------------------------------
//  All rights reserved. This program and the accompanying materials
//  are made available under the terms of the Eclipse Public License v1.0
//  and Apache License v2.0 which accompanies this distribution.
//
//      The Eclipse Public License is available at
//      http://www.eclipse.org/legal/epl-v10.html
//
//      The Apache License v2.0 is available at
//      http://www.opensource.org/licenses/apache2.0.php
//
//  You may elect to redistribute this code under either of these licenses.
//  ========================================================================
//

package org.eclipse.jetty.embedded;

import java.io.File;
import java.lang.management.ManagementFactory;

import org.eclipse.jetty.jmx.MBeanContainer;
import org.eclipse.jetty.security.HashLoginService;
import org.eclipse.jetty.server.Server;
import org.eclipse.jetty.webapp.WebAppContext;

public class OneWebApp
{
    public static void main( String[] args ) throws Exception
    {
        // Create a basic jetty server object that will listen on port 8080.
        // Note that if you set this to port 0 then a randomly available port
        // will be assigned that you can either look in the logs for the port,
        // or programmatically obtain it for use in test cases.
        Server server = new Server(8080);

        // Setup JMX
        MBeanContainer mbContainer = new MBeanContainer(
                ManagementFactory.getPlatformMBeanServer());
        server.addBean(mbContainer);

        // The WebAppContext is the entity that controls the environment in
        // which a web application lives and breathes. In this example the
        // context path is being set to "/" so it is suitable for serving root
        // context requests and then we see it setting the location of the war.
        // A whole host of other configurations are available, ranging from
        // configuring to support annotation scanning in the webapp (through
        // PlusConfiguration) to choosing where the webapp will unpack itself.
        WebAppContext webapp = new WebAppContext();
        webapp.setContextPath("/");
        File warFile = new File(
                "../../jetty-distribution/target/distribution/demo-base/webapps/test.war");
        webapp.setWar(warFile.getAbsolutePath());

        // A WebAppContext is a ContextHandler as well so it needs to be set to
        // the server so it is aware of where to send the appropriate requests.
        server.setHandler(webapp);

        // Configure a LoginService
        // Since this example is for our test webapp, we need to setup a
        // LoginService so this shows how to create a very simple hashmap based
        // one. The name of the LoginService needs to correspond to what is
        // configured in the webapp's web.xml and since it has a lifecycle of
        // its own we register it as a bean with the Jetty server object so it
        // can be started and stopped according to the lifecycle of the server
        // itself.
        HashLoginService loginService = new HashLoginService();
        loginService.setName("Test Realm");
        loginService.setConfig("src/test/resources/realm.properties");
        server.addBean(loginService);

        // Start things up! 
        server.start();

        // The use of server.join() the will make the current thread join and
        // wait until the server is done executing.
        // See http://docs.oracle.com/javase/7/docs/api/java/lang/Thread.html#join()
        server.join();
    }
}
]]>
        </script>
		</div>
		<div class="section">
			<div class="titlepage">
				<div>
					<div>
						<h3 class="title">
							<a name="d0e19002"></a>Like Jetty XML
						</h3>
					</div>
				</div>
			</div>
			<p>
				配置 Jetty 服务器的一个实例的通常方式是通过 <code class="literal">jetty.xml</code> 和相关的配置文件.然而,Jetty XML 配置格式只是一个你在代码中可以做什么的简单翻译.The <a class="link"
href="http://download.eclipse.org/jetty/stable-9/xref/org/eclipse/jetty/embedded/LikeJettyXml.html" target="_top">LikeJettyXml
示例</a> 从配置文件中获得代码中的行为.
			</p>
			<div class="itemizedlist">
				<ul class="itemizedlist" type="disc">
					<li class="listitem"><p>
							<a class="link"
								href="http://git.eclipse.org/c/jetty/org.eclipse.jetty.project.git/tree/jetty-server/src/main/config/etc/jetty.xml"
								target="_top">jetty.xml</a>
						</p></li>
					<li class="listitem"><p>
							<a class="link"
								href="http://git.eclipse.org/c/jetty/org.eclipse.jetty.project.git/tree/jetty-jmx/src/main/config/etc/jetty-jmx.xml"
								target="_top">jetty-jmx.xml</a>
						</p></li>
					<li class="listitem"><p>
							<a class="link"
								href="http://git.eclipse.org/c/jetty/org.eclipse.jetty.project.git/tree/jetty-server/src/main/config/etc/jetty-http.xml"
								target="_top">jetty-http.xml</a>
						</p></li>
					<li class="listitem"><p>
							<a class="link"
								href="http://git.eclipse.org/c/jetty/org.eclipse.jetty.project.git/tree/jetty-server/src/main/config/etc/jetty-https.xml"
								target="_top">jetty-https.xml</a>
						</p></li>
					<li class="listitem"><p>
							<a class="link"
								href="http://git.eclipse.org/c/jetty/org.eclipse.jetty.project.git/tree/jetty-deploy/src/main/config/etc/jetty-deploy.xml"
								target="_top">jetty-deploy.xml</a>
						</p></li>
					<li class="listitem"><p>
							<a class="link"
								href="http://git.eclipse.org/c/jetty/org.eclipse.jetty.project.git/tree/jetty-server/src/main/config/etc/jetty-stats.xml"
								target="_top">jetty-stats.xml</a>
						</p></li>
					<li class="listitem"><p>
							<a class="link"
								href="http://git.eclipse.org/c/jetty/org.eclipse.jetty.project.git/tree/jetty-server/src/main/config/etc/jetty-requestlog.xml"
								target="_top">jetty-requestlog.xml</a>
						</p></li>
					<li class="listitem"><p>
							<a class="link"
								href="http://git.eclipse.org/c/jetty/org.eclipse.jetty.project.git/tree/jetty-server/src/main/config/etc/jetty-lowresources.xml"
								target="_top">jetty-lowresources.xml</a>
						</p></li>
					<li class="listitem"><p>
							<a class="link"
								href="http://git.eclipse.org/c/jetty/org.eclipse.jetty.project.git/tree/tests/test-webapps/test-jetty-webapp/src/main/config/etc/test-realm.xml"
								target="_top">test-realm.xml</a>
						</p></li>
				</ul>
			</div>
			<script type="syntaxhighlighter" class="brush: plain;toolbar: false">
           <![CDATA[//
//  ========================================================================
//  Copyright (c) 1995-2014 Mort Bay Consulting Pty. Ltd.
//  ------------------------------------------------------------------------
//  All rights reserved. This program and the accompanying materials
//  are made available under the terms of the Eclipse Public License v1.0
//  and Apache License v2.0 which accompanies this distribution.
//
//      The Eclipse Public License is available at
//      http://www.eclipse.org/legal/epl-v10.html
//
//      The Apache License v2.0 is available at
//      http://www.opensource.org/licenses/apache2.0.php
//
//  You may elect to redistribute this code under either of these licenses.
//  ========================================================================
//

package org.eclipse.jetty.embedded;

import java.io.File;
import java.io.FileNotFoundException;
import java.lang.management.ManagementFactory;

import org.eclipse.jetty.deploy.DeploymentManager;
import org.eclipse.jetty.deploy.PropertiesConfigurationManager;
import org.eclipse.jetty.deploy.providers.WebAppProvider;
import org.eclipse.jetty.http.HttpVersion;
import org.eclipse.jetty.jmx.MBeanContainer;
import org.eclipse.jetty.security.HashLoginService;
import org.eclipse.jetty.server.Handler;
import org.eclipse.jetty.server.HttpConfiguration;
import org.eclipse.jetty.server.HttpConnectionFactory;
import org.eclipse.jetty.server.LowResourceMonitor;
import org.eclipse.jetty.server.NCSARequestLog;
import org.eclipse.jetty.server.SecureRequestCustomizer;
import org.eclipse.jetty.server.Server;
import org.eclipse.jetty.server.ServerConnector;
import org.eclipse.jetty.server.SslConnectionFactory;
import org.eclipse.jetty.server.handler.ContextHandlerCollection;
import org.eclipse.jetty.server.handler.DefaultHandler;
import org.eclipse.jetty.server.handler.HandlerCollection;
import org.eclipse.jetty.server.handler.RequestLogHandler;
import org.eclipse.jetty.server.handler.StatisticsHandler;
import org.eclipse.jetty.util.ssl.SslContextFactory;
import org.eclipse.jetty.util.thread.QueuedThreadPool;
import org.eclipse.jetty.util.thread.ScheduledExecutorScheduler;
import org.eclipse.jetty.webapp.Configuration;

/**
 * Starts the Jetty Distribution's demo-base directory using entirely
 * embedded jetty techniques.
 */
public class LikeJettyXml
{
    public static void main( String[] args ) throws Exception
    {
        // Path to as-built jetty-distribution directory
        String jettyHomeBuild = "../../jetty-distribution/target/distribution";
        
        // Find jetty home and base directories
        String homePath = System.getProperty("jetty.home", jettyHomeBuild);
        File homeDir = new File(homePath);
        if (!homeDir.exists())
        {
            throw new FileNotFoundException(homeDir.getAbsolutePath());
        }
        String basePath = System.getProperty("jetty.base", homeDir + "/demo-base");
        File baseDir = new File(basePath);
        if(!baseDir.exists())
        {
            throw new FileNotFoundException(baseDir.getAbsolutePath());
        }
        
        // Configure jetty.home and jetty.base system properties
        String jetty_home = homeDir.getAbsolutePath();
        String jetty_base = baseDir.getAbsolutePath();
        System.setProperty("jetty.home", jetty_home);
        System.setProperty("jetty.base", jetty_base);


        // === jetty.xml ===
        // Setup Threadpool
        QueuedThreadPool threadPool = new QueuedThreadPool();
        threadPool.setMaxThreads(500);

        // Server
        Server server = new Server(threadPool);

        // Scheduler
        server.addBean(new ScheduledExecutorScheduler());

        // HTTP Configuration
        HttpConfiguration http_config = new HttpConfiguration();
        http_config.setSecureScheme("https");
        http_config.setSecurePort(8443);
        http_config.setOutputBufferSize(32768);
        http_config.setRequestHeaderSize(8192);
        http_config.setResponseHeaderSize(8192);
        http_config.setSendServerVersion(true);
        http_config.setSendDateHeader(false);
        // httpConfig.addCustomizer(new ForwardedRequestCustomizer());

        // Handler Structure
        HandlerCollection handlers = new HandlerCollection();
        ContextHandlerCollection contexts = new ContextHandlerCollection();
        handlers.setHandlers(new Handler[] { contexts, new DefaultHandler() });
        server.setHandler(handlers);

        // Extra options
        server.setDumpAfterStart(false);
        server.setDumpBeforeStop(false);
        server.setStopAtShutdown(true);

        // === jetty-jmx.xml ===
        MBeanContainer mbContainer = new MBeanContainer(
                ManagementFactory.getPlatformMBeanServer());
        server.addBean(mbContainer);


        // === jetty-http.xml ===
        ServerConnector http = new ServerConnector(server,
                new HttpConnectionFactory(http_config));
        http.setPort(8080);
        http.setIdleTimeout(30000);
        server.addConnector(http);


        // === jetty-https.xml ===
        // SSL Context Factory
        SslContextFactory sslContextFactory = new SslContextFactory();
        sslContextFactory.setKeyStorePath(jetty_home + "/etc/keystore");
        sslContextFactory.setKeyStorePassword("OBF:1vny1zlo1x8e1vnw1vn61x8g1zlu1vn4");
        sslContextFactory.setKeyManagerPassword("OBF:1u2u1wml1z7s1z7a1wnl1u2g");
        sslContextFactory.setTrustStorePath(jetty_home + "/etc/keystore");
        sslContextFactory.setTrustStorePassword("OBF:1vny1zlo1x8e1vnw1vn61x8g1zlu1vn4");
        sslContextFactory.setExcludeCipherSuites("SSL_RSA_WITH_DES_CBC_SHA",
                "SSL_DHE_RSA_WITH_DES_CBC_SHA", "SSL_DHE_DSS_WITH_DES_CBC_SHA",
                "SSL_RSA_EXPORT_WITH_RC4_40_MD5",
                "SSL_RSA_EXPORT_WITH_DES40_CBC_SHA",
                "SSL_DHE_RSA_EXPORT_WITH_DES40_CBC_SHA",
                "SSL_DHE_DSS_EXPORT_WITH_DES40_CBC_SHA");

        // SSL HTTP Configuration
        HttpConfiguration https_config = new HttpConfiguration(http_config);
        https_config.addCustomizer(new SecureRequestCustomizer());

        // SSL Connector
        ServerConnector sslConnector = new ServerConnector(server,
            new SslConnectionFactory(sslContextFactory,HttpVersion.HTTP_1_1.asString()),
            new HttpConnectionFactory(https_config));
        sslConnector.setPort(8443);
        server.addConnector(sslConnector);


        // === jetty-deploy.xml ===
        DeploymentManager deployer = new DeploymentManager();
        deployer.setContexts(contexts);
        deployer.setContextAttribute(
                "org.eclipse.jetty.server.webapp.ContainerIncludeJarPattern",
                ".*/servlet-api-[^/]*\\.jar$");

        WebAppProvider webapp_provider = new WebAppProvider();
        webapp_provider.setMonitoredDirName(jetty_base + "/webapps");
        webapp_provider.setDefaultsDescriptor(jetty_home + "/etc/webdefault.xml");
        webapp_provider.setScanInterval(1);
        webapp_provider.setExtractWars(true);
        webapp_provider.setConfigurationManager(new PropertiesConfigurationManager());

        deployer.addAppProvider(webapp_provider);
        server.addBean(deployer);
        
        // === setup jetty plus ==
        Configuration.ClassList.setServerDefault(server).addAfter(
                "org.eclipse.jetty.webapp.FragmentConfiguration",
                "org.eclipse.jetty.plus.webapp.EnvConfiguration",
                "org.eclipse.jetty.plus.webapp.PlusConfiguration");

        // === jetty-stats.xml ===
        StatisticsHandler stats = new StatisticsHandler();
        stats.setHandler(server.getHandler());
        server.setHandler(stats);


        // === jetty-requestlog.xml ===
        NCSARequestLog requestLog = new NCSARequestLog();
        requestLog.setFilename(jetty_home + "/logs/yyyy_mm_dd.request.log");
        requestLog.setFilenameDateFormat("yyyy_MM_dd");
        requestLog.setRetainDays(90);
        requestLog.setAppend(true);
        requestLog.setExtended(true);
        requestLog.setLogCookies(false);
        requestLog.setLogTimeZone("GMT");
        RequestLogHandler requestLogHandler = new RequestLogHandler();
        requestLogHandler.setRequestLog(requestLog);
        handlers.addHandler(requestLogHandler);


        // === jetty-lowresources.xml ===
        LowResourceMonitor lowResourcesMonitor=new LowResourceMonitor(server);
        lowResourcesMonitor.setPeriod(1000);
        lowResourcesMonitor.setLowResourcesIdleTimeout(200);
        lowResourcesMonitor.setMonitorThreads(true);
        lowResourcesMonitor.setMaxConnections(0);
        lowResourcesMonitor.setMaxMemory(0);
        lowResourcesMonitor.setMaxLowResourcesTime(5000);
        server.addBean(lowResourcesMonitor);


        // === test-realm.xml ===
        HashLoginService login = new HashLoginService();
        login.setName("Test Realm");
        login.setConfig(jetty_base + "/etc/realm.properties");
        login.setRefreshInterval(0);
        server.addBean(login);

        
        // Start the server
        server.start();
        server.join();
    }
}
]]>
        </script>
		</div>
	</div>
	<script type="text/javascript">
		SyntaxHighlighter.all()
	</script>
	<div class="navfooter">
		<hr>
		<table width="100%" summary="Navigation footer">
			<tr>
				<td width="40%" align="left"><a accesskey="p" href="advanced-embedding.html"><i class="icon-chevron-left"></i>
						Previous</a>&nbsp;</td>
				<td width="20%" align="center"><a accesskey="u" href="advanced-embedding.html"><i class="icon-chevron-up"></i>
						Top</a></td>
				<td width="40%" align="right">&nbsp;<a accesskey="n" href="embedded-examples.html">Next <i
						class="icon-chevron-right"></i></a></td>
			</tr>
			<tr>
				<td width="40%" align="left" valign="top">Chapter&nbsp;25.&nbsp;Embedding&nbsp;</td>
				<td width="20%" align="center"><a accesskey="h" href="index.html"><i class="icon-home"></i> Home</a></td>
				<td width="40%" align="right" valign="top">&nbsp;Embedded Examples</td>
			</tr>
		</table>
	</div>
	<p xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension"
		xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook"
		xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net"
		xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times">
	<div class="jetty-callout">
		See an error or something missing? <span class="callout"><a
			href="http://github.com/jetty-project/jetty-documentation">Contribute to this documentation at <span
				class="website"><i class="icon-github"></i> Github!</span></a></span><span style="float: right"><i>(Generated:
				2014-10-21T11:19:26+08:00)</i></span>
	</div>
	</p>
	<script xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension"
		xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook"
		xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net"
		xmlns:gcse="http://www.google.com" xmlns:date="http://exslt.org/dates-and-times" type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push([ '_setAccount', 'UA-1149868-7' ]);
		_gaq.push([ '_trackPageview' ]);

		(function() {
			var ga = document.createElement('script');
			ga.type = 'text/javascript';
			ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl'
					: 'http://www')
					+ '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0];
			s.parentNode.insertBefore(ga, s);
		})();
	</script>
</body>
</html>